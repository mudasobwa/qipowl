<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>qipowl by mudasobwa</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>qipowl</h1>
          <h2>the next generation markup environment for virtually everything</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/mudasobwa/qipowl/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/mudasobwa/qipowl/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/mudasobwa/qipowl" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <p><img src="https://github.com/mudasobwa/typogrowl/raw/master/images/owl.png" alt="qipowl"></p>

<p>The main idea of <em>qipowl</em> is to yield the power of 
<a href="http://jroller.com/rolsen/entry/building_a_dsl_in_ruby">DSL in Ruby</a>.
The whole input text is treated neither more nor less than <code>DSL</code>. 
That gives the user an ability to make virtually every term in input text
the <em>operating entity</em>.</p>

<h2>
<a name="intro" class="anchor" href="#intro"><span class="octicon octicon-link"></span></a>Intro</h2>

<p>Everybody knows that parsing is annoying, error-prone and generally hazardous. That’s because the common old-school approach to parsing suc^W^W failed.</p>

<p>The problems are greatly exaggerated. The only thing we need to make the parsing process pleasant is to join <em>bootstrapping techniques</em>, <em>Ruby DSL abilities</em> and a bit of additional <em>Ruby coding</em>.</p>

<p>Like Baron Münchhausen, who allegedly pulled himself and the horse on which he was sitting out of a swamp by his own hair (or like <a href="http://en.wikipedia.org/wiki/Ouroboros">Ouroboros</a> if one prefers serpentariums to swamps), the text to be parsed should… Well, it should <strong>parse itself</strong>.</p>

<p><img src="http://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Muenchhausen_Herrfurth_7_500x789.jpg/152px-Muenchhausen_Herrfurth_7_500x789.jpg" alt="illustration by Oskar Herrfurth"></p>

<p>Ruby DSL has <em>all</em> the prerequisites for that. Let’s see.</p>

<h2>
<a name="bowler-basics" class="anchor" href="#bowler-basics"><span class="octicon octicon-link"></span></a>Bowler Basics</h2>

<p>The main principle of <strong>qipowl</strong> is:</p>

<h4>
<a name="all-the-input-text-is-interpreted-as-ruby-code" class="anchor" href="#all-the-input-text-is-interpreted-as-ruby-code"><span class="octicon octicon-link"></span></a>All the input text is interpreted as Ruby code.</h4>

<p>There is a rake¹ on our way, and we’re near to get on the forehead, so let’s watch our steps:</p>

<ul>
<li>Get rid of all the symbols, which may confuse ruby interpreter (e. g. <code>ASCII</code>); we simply <code>gsub</code> all the single-byte symbols to their “<a href="http://en.wikipedia.org/wiki/Fullwidth#In_Unicode">fullwidth</a>” representation.</li>
<li>Split input text to, say, “paragraphs” (by empty lines).</li>
<li>Process each line of result as if it was plain Ruby (<code>eval</code>; it’s safe).</li>
<li>
<code>gsub</code> wide characters back to <code>Latin1</code>.</li>
</ul><p>As we have done the four steps above, we’ve run into troubles with “undefined methods/constants” errors. Let’s see why. For instance, we are to proceed with the following string:</p>

<pre><code>I'm Brian, and so's my wife
</code></pre>

<p>After 1st step we yield:</p>

<pre><code>Ｉ＇ｍ Ｂｒｉａｎ， ａｎｄ ｓｏ＇ｓ ｍｙ ｗｉｆｅ
</code></pre>

<p>Step 2) is omitted, since we have the only string in the input. Now let’s give a chance to step 3). If we’d stop here and try to suggest, how ruby interpreter will be dealing with this garbage. Let’s take a look at this <em>valid</em> ruby command:</p>

<pre><code>puts rand hash
</code></pre>

<p>It surprisingly puts a huge random value. Ruby evaluates <code>hash</code>, passes the result of evaluation to <code>rand</code>, evaluates <code>rand</code> and, chaining the result, finally prints it out. Aha! But there is no such ruby functions like <code>ｗｉｆｅ</code>, <code>ｓｏ＇ｓ</code> or <code>Ｉ＇ｍ</code>. It’s time for <code>method_missing</code> come to scene.</p>

<pre><code>def respond_to?
  true
end

def method_missing method, *args, &amp;block
  method, *args = special_handler(method, *args, &amp;block) \
    if self.private_methods.include?(:special_handler)
  [method, args].flatten
end
</code></pre>

<p>Here we simply pass the parameters further in the chain, giving an aspect for intervention: if any of descendants have had <code>special_handler</code> method overwritten, it’ll be called.</p>

<p>Since we have these two methods <strong>only</strong>, we already have a void parser. It means our string will be executed as ruby code without any errors from within class, containing these methods.</p>

<pre><code>def parse string
  eval 'Ｉ＇ｍ Ｂｒｉａｎ， ａｎｄ ｓｏ＇ｓ ｍｙ ｗｉｆｅ'
end

# ⇒ 'Ｉ＇ｍ Ｂｒｉａｎ， ａｎｄ ｓｏ＇ｓ ｍｙ ｗｉｆｅ'
</code></pre>

<p>Nice scaffold, isn’t it? Here and further we call this base class <code>Bowler</code>.</p>

<hr><p>¹ True rake, I mean.</p>

<h2>
<a name="bowler-scaffold" class="anchor" href="#bowler-scaffold"><span class="octicon octicon-link"></span></a>Bowler Scaffold</h2>

<p>If it looks like a pan, stores like a pan, and sizzles like a pan, then it is a bowler. </p>

<p>I choose the name <code>Bowler</code> for the base class because every process usually has three stages:</p>

<ul>
<li>prepare</li>
<li>perform</li>
<li>??? (I’ve heard there is no such word “postpare” in English</li>
</ul><p>My process also has these stages and I needed clear easy-to-remember names for them. Here we are:</p>

<ul>
<li>defreeze</li>
<li>roast</li>
<li>serveup</li>
</ul><p>Since the bowler introduced in the <a href="/mudasobwa/qipowl/wiki/1.-Bowler-Basics">previous chapter</a> has a middling meaning, we need more built-in helpers for future use. First of all, we need to fullwidth the input in <code>defreeze</code>, to break in into “paragraphs” in <code>roast</code> and to <code>gsub</code> it back to normal characters in <code>serveup</code>. Secondary, we need to be able to store some processing rules in config file (which is to be <code>YAML</code> and should be loaded by base class.)</p>

<p>That’s all for now, we’ll turn back to this class later.</p>

<h2>
<a name="processing-chain" class="anchor" href="#processing-chain"><span class="octicon octicon-link"></span></a>Processing chain</h2>

<p>Within default <code>Bowler</code>, the input string is simply eaten by ruby interpreter and spitted out then. Not so useful, huh?</p>

<p>Well, let’s recall that <em>each</em> “word” in input string is currently handled by <code>method_missing</code>. What if we <strong>declare</strong> new method within class derived from <code>Bowler</code>?</p>

<pre><code># Ｉ＇ｍ Ｂｒｉａｎ ａｎｄ ｓｏ＇ｓ ｍｙ ｗｉｆｅ
class Herald
  def Ｂｒｉａｎ *args
    me = __callee__
    [me, ', the Herald, honour me,', *args]
  end
end
</code></pre>

<p>After we have the input string processed by this class, the output became:</p>

<pre><code>I'm Brian, the Herald, honour me, and so's my wife!
</code></pre>

<p>Cute, huh?</p>

<p>There are ready-to-use examples for command line parser, markdown-like markup to HTML parser and even YAML loader provided.</p>
        </section>

        <footer>
          qipowl is maintained by <a href="https://github.com/mudasobwa">mudasobwa</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>